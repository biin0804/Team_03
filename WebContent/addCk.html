<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>체크리스트 추가</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="css/addCk.css">
 
</head>
<body>

<div class="page-layout">

		<!-- 관리자용 상단바 -->
		<nav class="navbar">
			<div class="container">
				<a class="navbar-brand" href="#"> <img src="image/logo.png"
					alt="로고" />
				</a>

				<!-- 로고 옆 관리자 텍스트 + 로그아웃 버튼 -->
				<div class="admin-info d-flex align-items-center ms-3">
					<span class="admin-greeting">관리자님 안녕하세요.</span>
					<button class="logout-btn ms-2">로그아웃</button>
				</div>

				<!-- 메뉴 항목 -->
				<div class="menu-wrapper ms-auto">
					<div class="dropdown">
						<a class="nav-link dropdown-toggle no-underline" href="#"
							role="button" data-bs-toggle="dropdown" aria-expanded="false">
							체크리스트 </a>
						<ul class="dropdown-menu dropdown-menu-end">
							<li><a class="dropdown-item" href="#">현재 체크리스트</a></li>
							<li><a class="dropdown-item" href="#">이전 체크리스트</a></li>
						</ul>
					</div>
					<div class="dropdown">
						<a class="nav-link dropdown-toggle no-underline" href="#"
							role="button" data-bs-toggle="dropdown" aria-expanded="false">
							지원금 정보 </a>
						<ul class="dropdown-menu dropdown-menu-end">
							<li><a class="dropdown-item" href="#">현재 지원금 정보</a></li>
							<li><a class="dropdown-item" href="#">이전 지원금 정보</a></li>
						</ul>
					</div>
					<div class="dropdown">
						<a class="nav-link dropdown-toggle no-underline" href="#"
							role="button" data-bs-toggle="dropdown" aria-expanded="false">
							문의관리 </a>
						<ul class="dropdown-menu dropdown-menu-end">
							<li><a class="dropdown-item" href="#">FAQ</a></li>
							<li><a class="dropdown-item" href="#">1:1 문의관리</a></li>
						</ul>
					</div>
				</div>
			</div>
		</nav>

<div class="container">
  <div class="set-title">
    <span class="set-text">집보기</span>
  </div>
 
  <div id="inputArea"></div>

  <div class="add-content">
    <button type="button" class="btn btn-outline-danger" id="removeContentBtn">-</button>
    <button type="button" class="btn btn-outline-secondary" id="addContentBtn">+</button>
  </div>

  <div class="button-wrapper">
    <button id="cancel" class="cancel" onclick="cancelAction()">취 소</button>
    <button id="save" class="save" onclick="saveAllAndGo()">저 장</button>
  </div>
</div>
</div>
<script>
let isFirstBlock = true;

function createInputBlock() {
const div = document.createElement("div");
div.className = "input-block";

div.innerHTML = `
 <h5>제목</h5>
 <input type="text" class="form-control mb-3" name="ck_title" placeholder="제목을 입력하세요">

 <h5>본문</h5>
 <textarea class="form-control mb-3" name="ck_content" rows="1" placeholder="본문 내용을 입력하세요"></textarea>
 ${isFirstBlock ? `
   <div class="tip-box">
     <i class="bi bi-pin-fill pin-icon"></i>
     <p class="tip-title">TIP</p>
     <textarea class="form-control" name="ck_tip" rows="1" placeholder="TIP 내용을 입력하세요"></textarea>
   </div>
 ` : ""}
`;

isFirstBlock = false;

div.querySelectorAll("textarea").forEach(textarea => {
 textarea.addEventListener("input", () => autoGrow(textarea));
});

return div;
}

function autoGrow(el) {
el.style.height = "auto";
el.style.height = el.scrollHeight + "px";
}

document.getElementById("inputArea").appendChild(createInputBlock());

document.getElementById("addContentBtn").addEventListener("click", () => {
const newBlock = createInputBlock();
const tipBlock = document.querySelector(".tip-box")?.parentElement;

if (tipBlock) {
 document.getElementById("inputArea").insertBefore(newBlock, tipBlock);
} else {
 document.getElementById("inputArea").appendChild(newBlock);
}
});

document.getElementById("removeContentBtn").addEventListener("click", () => {
const blocks = document.querySelectorAll(".input-block");
if (blocks.length <= 1) return;

const lastBlock = Array.from(blocks).reverse().find(b => !b.querySelector(".tip-box"));
if (lastBlock) lastBlock.remove();
});

document.getElementById("save").addEventListener("click", () => {
const titles = document.getElementsByName("ck_title");
const contents = document.getElementsByName("ck_content");
const tips = document.getElementsByName("ck_tip");

for (let i = 0; i < titles.length; i++) {
 console.log(`제목: ${titles[i].value}`);
 console.log(`본문: ${contents[i].value}`);
 if (tips[i]) console.log(`TIP: ${tips[i].value}`);
 console.log("----------");
}
});
function cancelAction() {
    window.location.href = 'ckHomeManager.html'; // 취소 후 이동할 페이지
  }
function saveAllAndGo() {
    // 입력된 모든 제목, 본문, TIP 가져오기
    const titles = document.getElementsByName("ck_title");
    const contents = document.getElementsByName("ck_content");
    const tips = document.getElementsByName("ck_tip");

    const dataList = [];

    for (let i = 0; i < titles.length; i++) {
        const title = titles[i].value.trim();
        const content = contents[i].value.trim();
        const tip = tips[i] ? tips[i].value.trim() : null; // 첫 번째 블럭에만 TIP 있을 수도 있음

        dataList.push({
            title: title,
            content: content,
            tip: tip       
        });
        
    }

    // 이제 fetch로 서버로 전송
    fetch('/controller?cmd=addCk', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(dataList)
    })
    .then(response => {
        if (!response.ok) throw new Error('저장 실패');
        return response.text();
    })
    .then(data => {
        alert('저장 완료되었습니다.');
        window.location.href = "ckHomeManagerUI";
    })
    .catch(error => {
        alert('저장 실패');
        console.error(error);
    });
    function saveCategory() {
        const categoryName = document.getElementById('categoryInput').value.trim();

        if (!categoryName) {
          alert('카테고리 이름을 입력해주세요.');
          return;
        }

        // 서버에 카테고리 저장
        fetch('/saveCategory', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ category: categoryName })  // 서버로 카테고리 이름만 보냄
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // 저장 성공했으면, 그냥 페이지 이동 (데이터 넘기지 않음)
            window.location.href = "ckHomeManagerUI.html";
          } else {
            alert('카테고리 저장에 실패했습니다.');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('카테고리 저장에 실패했습니다.');
        });
    }

}
</script>

</body>
</html>
