<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link
	href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<link rel="stylesheet" href="css/component.css">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7"
	crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="css/setHomeManager.css">

</head>
<body>
<div class="page-layout">
    <div class="container">
      <!-- Navbar -->
      <nav class="navbar">
        <div class="container">
          <a class="navbar-brand" href="#"> <img src="image/logo.png" alt="로고" /> </a>
          <div class="admin-info d-flex align-items-center ms-3">
            <span class="admin-greeting">관리자님 안녕하세요.</span>
            <button class="logout-btn ms-2">로그아웃</button>
          </div>
          <div class="menu-wrapper ms-auto">
            <div class="dropdown">
              <a class="nav-link dropdown-toggle no-underline" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"> 체크리스트 </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#">현재 체크리스트</a></li>
                <li><a class="dropdown-item" href="#">이전 체크리스트</a></li>
              </ul>
            </div>
            <div class="dropdown">
              <a class="nav-link dropdown-toggle no-underline" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"> 지원금 정보 </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#">현재 지원금 정보</a></li>
                <li><a class="dropdown-item" href="#">이전 지원금 정보</a></li>
              </ul>
            </div>
            <div class="dropdown">
              <a class="nav-link dropdown-toggle no-underline" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"> 문의관리 </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#">FAQ</a></li>
                <li><a class="dropdown-item" href="#">1:1 문의관리</a></li>
              </ul>
            </div>
          </div>
        </div>
      </nav>

      <!-- Page Content -->
      <div class="set-title">
        <i class="bi bi-pencil-fill pencil-icon"></i>
        <span class="set-text">집보기</span>
      </div>

      <div class="set-container">
        <h2 class="set-ready">사전 준비</h2>
        <p>원하는 조건 정리: 위치, 보증금/월세, 관리비 포함 여부, 옵션(가전), 엘리베이터, 주차 등</p>
        <p class="set-detail">부동산 앱(직방, 다방 등) 또는 공인중개사를 통해 매물 수집</p>
        <div class="action-button-group">
          <button class="edit-btn" onclick="goToCkContentUI()">수정</button>
          <button class="delete-btn" onclick="deleteContent(event)">삭제</button>
        </div>
      </div>

      <div class="text-container">
        <h2>체크리스트</h2>
        <p>구조 : 실제 평수, 채광, 방 크기, 벽 두께 (소음)</p>
        <p>옵션 : 에어컨, 냉장고, 세탁기, 가스레인지 등 작동 여부</p>
        <p>보일러 : 난방 잘 되는지, 온수 잘 나오는지</p>
        <p>수도/전기 : 수도꼭지 누수 여부, 콘센트 위치 및 개수</p>
        <p>하자 : 곰팡이, 벽지 들뜸, 창문 닫힘 여부, 바닥 긁힘</p>
        <p>보안 : 현관 이중 잠금 여부, CCTV 유무, 현관 비밀번호 설정 여부</p>
        <p>기타 : 엘리베이터 유무, 층간소음, 주변 편의시설 (마트, 정류장 등)</p>

        <div class="action-button-group">
          <button class="edit-btn" onclick="goToCkContentUI()">수정</button>
          <button class="delete-btn" onclick="deleteContent(event)">삭제</button>
        </div>
      </div>

      <!-- TIP 박스 -->
      <div class="tip-box">
        <i class="bi bi-pin-fill pin-icon"></i>
        <p class="tip-title">TIP</p>
        <div id="tipContentDiv">
          <p class="tip-content" id="tipContent">개별난방은 사용자가 직접 난방을 조절할 수 있다.</p>
          <p class="tip-content">집을 비우면 난방을 끄면 되므로, 그만큼 요금도 줄어든다.</p>
          <br>
          <p class="tip-content">중앙난방은 난방을 관리실이나 집주인이 조절해서 집을 비워도 모두가 난방비는 똑같이 나온다.</p>
          <p class="tip-content">계약서 기준 금액을 넘는 공용난방비는 추가 부담될 수 있다.</p>
          <p class="tip-content">대신 온수가 바로 나온다.</p>
        </div>
        <div class="action-button-group">
          <button class="edit-btn" onclick="editTipContent()">수정</button>
          <button class="delete-btn" onclick="deleteTipContent()">삭제</button>
        </div>
      </div>

      <div class="bottom-button-group">
        <button class="gray-btn" onclick="deleteAllAndGo()">삭 제</button>
        <button class="gray-btn" onclick="cancelAndGoBack()">취 소</button>
        <button class="yellow-btn" onclick="saveAllAndGo()">저 장</button>
      </div>
    </div>
  </div>
<script>
const navLinks = document.querySelectorAll('.nav-link');

navLinks.forEach(link => {
    link.addEventListener('click', function () {
        navLinks.forEach(item => {
            if (!item.classList.contains('no-underline')) {
                item.classList.remove('active');
            }
        });
        if (!this.classList.contains('no-underline')) {
            this.classList.add('active');
        }
    });
});

// 수정 버튼 클릭 시 텍스트를 textarea로 변환
function editTipContent() {
    const tipContentDiv = document.getElementById('tipContentDiv');
    const paragraphs = tipContentDiv.querySelectorAll('.tip-content');

    let combinedText = "";
    paragraphs.forEach(p => {
        combinedText += p.textContent + "\n";
    });

    tipContentDiv.innerHTML = `
        <textarea id="tipEditArea" style="width:100%; height:200px;">${combinedText.trim()}</textarea>
    `;

    const editButton = tipContentDiv.nextElementSibling.querySelector('.edit-btn');
    editButton.textContent = "저장";
    editButton.setAttribute('onclick', 'saveTipContent()');
}
function deleteTipContent() {
    if (!confirm("정말 TIP 내용을 삭제하시겠습니까?")) return;

    fetch('/controller?cmd=deleteTip', {
        method: 'POST'
    })
    .then(response => {
        if (!response.ok) throw new Error("삭제 실패");
        return response.text();
    })
    .then(data => {
        // 삭제 성공 시 화면에서 TIP 내용 제거
        const tipContentDiv = document.getElementById('tipContentDiv');
        tipContentDiv.innerHTML = "<p class='tip-content text-muted'>삭제된 TIP입니다.</p>"; // 빈 텍스트로 남겨도 됨
        alert('TIP이 삭제되었습니다.');
    })
    .catch(error => {
        console.error("삭제 실패:", error);
        alert("TIP 삭제 중 오류 발생");
    });
}

// 저장 버튼 클릭 시 수정된 내용을 서버로 전송
function saveTipContent() {
    const editedContent = document.getElementById('tipEditArea').value.trim();
   
    if (editedContent === "") {
        alert("내용을 입력하세요.");
        return;
    }

    const lines = editedContent.split('\n');
    let newHtml = '';
    lines.forEach(line => {
        if (line.trim() !== "") {
            newHtml += `<p class="tip-content">${line.trim()}</p>`;
        }
    });

    const tipContentDiv = document.getElementById('tipContentDiv');
    tipContentDiv.innerHTML = newHtml;

    const editButton = tipContentDiv.nextElementSibling.querySelector('.edit-btn');
    editButton.textContent = "수정";
    editButton.setAttribute('onclick', 'editTipContent()');

    sendTipToServer(editedContent);
}

// 서버로 수정된 팁 내용을 AJAX로 보내는 함수
function sendTipToServer(editedContent) {
    fetch('/controller?cmd=setTip', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ tip: editedContent })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('서버 오류');
        }
        return response.text();
    })
    .then(data => {
        console.log("서버 응답:", data);
        alert('TIP이 성공적으로 저장되었습니다.');
    })
    .catch(error => {
        console.error('에러 발생:', error);
        alert('저장에 실패했습니다.');
    });
}
//수정 버튼 클릭 시 ckContentUI 페이지로 이동
function goToCkContentUI() {
	window.location.href = "setCkContentUI.html";  // 너가 이동하고 싶은 페이지 경로
}

// 삭제 버튼 클릭 시 DB 삭제
function deleteContent(event) {
    if (!confirm('정말 삭제하시겠습니까?')) {
        return;
    }

    // 삭제할 대상 div 찾기
    const target = event.target.closest('.set-container') || event.target.closest('.text-container');
    if (!target) {
        alert('삭제할 대상을 찾을 수 없습니다.');
        return;
    }

    // 실제 삭제할 ck_content_num 가져와야 함 (여기선 임시로 1)
    fetch('/controller?cmd=deleteCkContent', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ ckContentNum: 1 })  // 실제 넘버로 수정 필요
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('삭제 실패');
        }
        return response.text();
    })
    .then(data => {
        console.log('삭제 성공:', data);
        alert('삭제되었습니다.');

        // 화면에서도 바로 삭제
        target.remove();
    })
    .catch(error => {
        console.error('삭제 에러:', error);
        alert('삭제에 실패했습니다.');
    });
}
//하단 삭제 버튼
function deleteAllAndGo() {
    if (!confirm('정말 삭제하시겠습니까?')) return;

    fetch('/controller?cmd=deleteAllHomeData', {
        method: 'POST'
    })
    .then(response => {
        if (!response.ok) throw new Error('삭제 실패');
        return response.text();
    })
    .then(data => {
        alert('모든 항목이 삭제되었습니다.');
        window.location.href = '/ckHomeManagerUI';
    })
    .catch(error => {
        alert('삭제 중 오류 발생');
        console.error(error);
    });
}

// 하단 취소 버튼
function cancelAndGoBack() {
    window.location.href = '/ckHomeManagerUI';
}

// 하단 저장 버튼
function saveAllAndGo() {
    // 예시로 TIP만 저장하고 이동하는 구조
    const tipTextList = document.querySelectorAll('#tipContentDiv .tip-content');
    let combinedTip = '';
    tipTextList.forEach(p => {
        combinedTip += p.textContent.trim() + '\n';
    });
 const title = document.querySelector('.set-ready').textContent.trim();
 const readyDetail = document.querySelector('.set-detail').textContent.trim();
 
 const checkList = document.querySelectorall('.text-container p');
 let checkListContent = "";
 checkList.forEach(p => {
	 checkListContent += p.textContent.trim() + '\n';
 })
 	
    fetch('/controller?cmd=saveAllHomeData', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            tip: combinedTip.trim(),
            title: title,
            ready: readyDetail,
            checkList: checkListContent.trim()
        })
    })
    .then(response => {
        if (!response.ok) throw new Error('저장 실패');
        return response.text();
    })
    .then(data => {
        alert('저장 완료되었습니다.');
        window.location.href = '/ckHomeManagerUI';
    })
    .catch(error => {
        alert('저장 실패');
        console.error(error);
    });
}
</script>

</body>
</html>
